<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø­ÙƒÙ‘Ø§Ù… - Ø§Ù„Ù‡Ø§ÙƒØ§Ø«ÙˆÙ†</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#111c33; --muted:#94a3b8; --text:#e5e7eb;
      --line:rgba(148,163,184,.18); --ok:#22c55e; --danger:#ef4444; --brand:#38bdf8; --warn:#f59e0b;
      --shadow:0 14px 40px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:1150px; margin:auto; padding:18px}
    .topbar{
      background:rgba(15,23,42,.7); border:1px solid var(--line); border-radius:var(--r);
      padding:14px 16px; box-shadow:var(--shadow);
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center
    }
    h1{margin:0; font-size:16px}
    .sub{margin-top:6px; color:var(--muted); font-size:12px}
    .tabs{display:flex; gap:10px; flex-wrap:wrap}
    .tab{cursor:pointer; user-select:none; padding:10px 12px; border-radius:999px; font-weight:900;
      border:1px solid var(--line); background:rgba(17,28,51,.55)}
    .tab.active{background:rgba(56,189,248,.18); border-color:rgba(56,189,248,.4)}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(15,23,42,.7); border:1px solid var(--line); border-radius:var(--r); padding:14px; box-shadow:var(--shadow)}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:14px; border:1px solid var(--line);
      background:rgba(17,28,51,.55); color:var(--text); outline:none; font-size:14px
    }
    textarea{min-height:78px; resize:vertical}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{border:0; border-radius:14px; padding:11px 14px; font-weight:900; cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, rgba(56,189,248,.95), rgba(34,197,94,.92)); color:#07121f}
    .btn.ghost{background:rgba(17,28,51,.55); border:1px solid var(--line); color:var(--text)}
    .btn.danger{background:rgba(239,68,68,.92); color:#190508}
    .pillRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(17,28,51,.55); color:var(--muted); font-size:12px}
    .pill b{color:var(--text)}
    .msg{margin-top:10px; font-size:13px; color:var(--muted)}
    .msg.ok{color:var(--ok); font-weight:900}
    .msg.err{color:var(--danger); font-weight:900}
    .teams{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px}
    @media (max-width:980px){.teams{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.teams{grid-template-columns:1fr}}
    .teamCard{
      border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(17,28,51,.45);
      cursor:pointer;
    }
    .teamTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .teamId{font-weight:1000}
    .state{font-weight:1000; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line)}
    .state.done{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35)}
    .state.todo{background:rgba(245,158,11,.10); border-color:rgba(245,158,11,.30)}
    .small{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.5}
    .criteriaItem{border:1px solid var(--line); background:rgba(17,28,51,.45); border-radius:16px; padding:12px; margin:10px 0}
    .criteriaTitle{margin:0; font-size:13px; font-weight:1000; line-height:1.5}
    .critGrid{display:grid; grid-template-columns:170px 1fr; gap:10px; margin-top:10px}
    @media (max-width:720px){.critGrid{grid-template-columns:1fr}}
    .totalBar{display:flex; justify-content:space-between; align-items:center; gap:10px; border-radius:16px;
      padding:12px 14px; background:rgba(56,189,248,.12); border:1px solid rgba(56,189,248,.28)}
    .totalBar .big{font-size:16px; font-weight:1000}
    .tableWrap{overflow:auto; border-radius:16px; border:1px solid var(--line); margin-top:12px}
    table{width:100%; border-collapse:collapse; min-width:760px; background:rgba(17,28,51,.45)}
    th,td{padding:10px 12px; border-bottom:1px solid var(--line); font-size:13px; text-align:right}
    th{color:var(--muted); background:rgba(17,28,51,.65)}
    .rank{display:inline-flex; min-width:34px; justify-content:center; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:rgba(255,255,255,.03); font-weight:1000}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø­ÙƒÙ‘Ø§Ù…</h1>
      <div class="sub">ÙŠÙ…Ø³Ø­ QR â†’ ÙŠÙØªØ­ Ø§Ù„ÙØ±ÙŠÙ‚ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ â†’ ØªÙ‚ÙŠÙŠÙ… â†’ Ø­ÙØ¸ â†’ âœ… ÙŠØ¸Ù‡Ø± Ø£Ù…Ø§Ù… Ø§Ù„ÙØ±ÙŠÙ‚</div>
    </div>
    <div class="tabs">
      <div class="tab" id="tabDash">Ø§Ù„ÙØ±Ù‚</div>
      <div class="tab" id="tabEval">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div>
      <div class="tab" id="tabRes">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
    </div>
  </div>

  <!-- DASH -->
  <section id="pageDash" style="display:none">
    <div class="grid">
      <div class="card">
        <h1 style="font-size:14px;margin:0">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙƒÙ…</h1>
        <div class="small">Ø§ÙƒØªØ¨ Ø§Ø³Ù…/Ø±Ù…Ø² Ø§Ù„Ø­ÙƒÙ… (Ø¹Ø´Ø§Ù† âœ… ØªÙƒÙˆÙ† Ø®Ø§ØµØ© ÙÙŠÙƒ ÙˆØªÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)</div>
        <label>Judge ID</label>
        <input id="judgeId" placeholder="Ù…Ø«Ø§Ù„: J01 Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø­ÙƒÙ…" />
        <label>Ø¨Ø­Ø«</label>
        <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù…/ÙƒÙˆØ¯ Ø§Ù„ÙØ±ÙŠÙ‚ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" />
        <div class="btnRow">
          <button class="btn primary" id="btnReload">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          <button class="btn ghost" id="btnCopyCurrentLink">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
        </div>
        <div class="msg" id="dashMsg"></div>
      </div>

      <div class="card">
        <h1 style="font-size:14px;margin:0">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h1>
        <div class="pillRow">
          <div class="pill">Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚: <b id="countTeams">0</b></div>
          <div class="pill">ØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡ (Ù…Ù†Ùƒ): <b id="countDone">0</b></div>
          <div class="pill">Ù…ØªØ¨Ù‚ÙŠ (Ù„Ùƒ): <b id="countTodo">0</b></div>
        </div>
        <div class="small" style="margin-top:10px">
          ØªÙ„Ù…ÙŠØ­: QR ÙŠÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø«Ù„ <b>?team=T07</b> ÙˆÙŠÙˆØ¯ÙŠÙƒ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØªÙ‚ÙŠÙŠÙ….
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h1 style="font-size:14px;margin:0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±Ù‚</h1>
      <div class="teams" id="teamsGrid"></div>
    </div>
  </section>

  <!-- EVALUATE -->
  <section id="pageEval" style="display:none">
    <div class="grid">
      <div class="card">
        <h1 style="font-size:14px;margin:0">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h1>
        <div class="pillRow">
          <div class="pill">Team ID: <b id="pillTeam">â€”</b></div>
          <div class="pill">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: <b id="pillProject">â€”</b></div>
          <div class="pill">Ø§Ù„Ø¬Ù‡Ø©: <b id="pillOrg">â€”</b></div>
        </div>
        <div id="criteriaContainer"></div>
      </div>

      <div class="card">
        <h1 style="font-size:14px;margin:0">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h1>
        <label>Team ID</label>
        <input id="teamId" placeholder="T07" />
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
        <input id="projectTitle" placeholder="HealthAI" />
        <label>Ø§Ù„Ø¬Ù‡Ø©</label>
        <input id="org" placeholder="Ø¬Ø§Ù…Ø¹Ø© ..." />

        <div class="totalBar" style="margin-top:12px">
          <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
          <div class="big"><span id="total">0</span> / 65</div>
        </div>

        <div class="btnRow">
          <button class="btn primary" id="btnSave">Ø­ÙØ¸</button>
          <button class="btn ghost" id="btnNext">Ø§Ù„ØªØ§Ù„ÙŠ</button>
          <button class="btn danger" id="btnClear">Ù…Ø³Ø­</button>
        </div>
        <div class="msg" id="evalMsg"></div>
      </div>
    </div>
  </section>

  <!-- RESULTS -->
  <section id="pageRes" style="display:none">
    <div class="grid">
      <div class="card">
        <h1 style="font-size:14px;margin:0">Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø­Ø³Ø¨ Ù…ØªÙˆØ³Ø· Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­ÙƒÙ‘Ø§Ù…)</h1>
        <div class="btnRow">
          <button class="btn primary" id="btnRefreshResults">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
        </div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Team ID</th>
                <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</th>
                <th>Ø§Ù„Ø¬Ù‡Ø©</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙƒØ§Ù…</th>
                <th>Ù…ØªÙˆØ³Ø·</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
        <div class="msg" id="resMsg"></div>
      </div>

      <div class="card">
        <h1 style="font-size:14px;margin:0">Top 3</h1>
        <div id="top3"></div>
        <div class="small" style="margin-top:10px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‡Ù†Ø§ Ø¹Ø§Ù…Ø©ØŒ Ù…Ùˆ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø­ÙƒÙ… Ù…Ø¹ÙŠÙ‘Ù†.</div>
      </div>
    </div>
  </section>
</div>

<script>
/* =========================
   CONFIG (JSONBin)
   ========================= */
const JSONBIN_BIN_ID  = "699c7c98d0ea881f40d25331";
const JSONBIN_API_KEY = "$2a$10$8rkoiVkou/iglqXxQNfmduvpxAqN6XY6fILRTcIcc0Hw1MyF2g8sa";

/* =========================
   Criteria
   ========================= */
const CRITERIA = [
  "ÙˆØ¶ÙˆØ­ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© ÙˆÙ…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ÙÙƒØ±Ø© Ù„Ù‡Ø§",
  "Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø±ØªØ¨Ø§Ø·Ù‡ Ø¨Ø§Ù„ÙÙƒØ±Ø© ÙˆØ¹Ù…Ù‚ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©",
  "ÙˆØ¬ÙˆØ¯/ÙˆØ¶ÙˆØ­ Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ‚Ù†ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ³ØªÙ†Ø¯ Ø¥Ù„ÙŠÙ‡ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±",
  "Ø¥Ø¨Ø¯Ø§Ø¹ ÙˆØªÙ…ÙŠÙ‘Ø² Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±",
  "Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ù„Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©",
  "ØªÙ…ÙŠÙ‘Ø² Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø± Ø¹Ù† Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙØ±Ø© + Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ÙŠ",
  "ÙˆØ¶ÙˆØ­ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© + Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±",
  "ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¹ÙˆØ§Ø¦Ù‚ ÙˆØ®Ø·Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°",
  "Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„ØªÙ†ÙÙŠØ° ÙˆÙˆØ§Ù‚Ø¹ÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª (Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ‰)",
  "Ø¬Ø¯ÙˆÙ‰ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø± ØµØ­ÙŠÙ‹Ø§ ÙˆØ§Ù‚ØªØµØ§Ø¯ÙŠÙ‹Ø§ ÙˆØ§Ø¬ØªÙ…Ø§Ø¹ÙŠÙ‹Ø§",
  "Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ (Ø¥Ù„Ù‚Ø§Ø¡/Ù„ØºØ© Ø¬Ø³Ø¯/Ø§Ù„ØªØ²Ø§Ù… ÙˆÙ‚Øª)",
  "ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§ÙƒØªÙ…Ø§Ù„ Ø¹Ù†Ø§ØµØ±Ù‡",
  "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù„Ø¬Ù†Ø© Ø¨Ø¯Ù‚Ø© ÙˆÙ…Ù‡Ù†ÙŠØ©"
];

/* =========================
   Utils
   ========================= */
const $ = (id)=>document.getElementById(id);
const qsa = (sel)=>[...document.querySelectorAll(sel)];
function safe(x){ return String(x ?? "").trim(); }
function msg(el, text, kind=""){ el.className="msg"+(kind?(" "+kind):""); el.textContent=text; }

function setTab(name){
  const show = (id, on)=>$(id).style.display = on ? "block" : "none";
  show("pageDash", name==="dash");
  show("pageEval",  name==="eval");
  show("pageRes",   name==="res");
  $("tabDash").classList.toggle("active", name==="dash");
  $("tabEval").classList.toggle("active", name==="eval");
  $("tabRes").classList.toggle("active", name==="res");
  location.hash = "#/"+name;
}

function getParam(name){
  const url = new URL(location.href);
  return safe(url.searchParams.get(name));
}

/* =========================
   JSONBin API
   record: { teams:[], evaluations:[] }
   evaluations item:
   { teamId, projectTitle, org, judgeId, total, items:[...], savedAt }
   ========================= */
async function getRecord(){
  const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
    headers: { "X-Master-Key": JSONBIN_API_KEY }
  });
  if(!res.ok) throw new Error("Fetch failed");
  const data = await res.json();
  const r = data?.record || { teams:[], evaluations:[] };
  r.teams = Array.isArray(r.teams) ? r.teams : [];
  r.evaluations = Array.isArray(r.evaluations) ? r.evaluations : [];
  return r;
}
async function putRecord(record){
  const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`,{
    method:"PUT",
    headers:{ "Content-Type":"application/json", "X-Master-Key": JSONBIN_API_KEY },
    body: JSON.stringify(record)
  });
  if(!res.ok) throw new Error("Update failed");
}

/* =========================
   State
   ========================= */
let state = { teams:[], evaluations:[] };
let currentTeamId = ""; // Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù†

function calcTotal(){
  const sum = qsa(".score").reduce((a,s)=>a+Number(s.value||0),0);
  $("total").textContent = sum;
  return sum;
}
function updatePills(){
  $("pillTeam").textContent = safe($("teamId").value) || "â€”";
  $("pillProject").textContent = safe($("projectTitle").value) || "â€”";
  $("pillOrg").textContent = safe($("org").value) || "â€”";
}

/* =========================
   Render criteria
   ========================= */
function renderCriteria(){
  const box = $("criteriaContainer");
  box.innerHTML = "";
  CRITERIA.forEach((text,i)=>{
    const div = document.createElement("div");
    div.className = "criteriaItem";
    div.innerHTML = `
      <p class="criteriaTitle">${i+1}) ${text}</p>
      <div class="critGrid">
        <div>
          <label>Ø§Ù„Ø¯Ø±Ø¬Ø©</label>
          <select class="score" data-i="${i}">
            <option value="0">Ø§Ø®ØªØ±</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option>
          </select>
        </div>
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <textarea class="note" data-i="${i}" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea>
        </div>
      </div>
    `;
    box.appendChild(div);
  });
  calcTotal(); updatePills();
}

/* =========================
   Dashboard
   ========================= */
function isDoneForJudge(teamId, judgeId){
  const t = safe(teamId).toLowerCase();
  const j = safe(judgeId).toLowerCase();
  return state.evaluations.some(e =>
    safe(e.teamId).toLowerCase()===t && safe(e.judgeId).toLowerCase()===j
  );
}

function renderTeams(){
  const grid = $("teamsGrid");
  grid.innerHTML = "";

  const judgeId = safe($("judgeId").value);
  const query = safe($("search").value).toLowerCase();

  const teams = state.teams
    .slice()
    .sort((a,b)=> safe(a.id).localeCompare(safe(b.id),"en",{numeric:true}))
    .filter(t => {
      if(!query) return true;
      return safe(t.id).toLowerCase().includes(query)
        || safe(t.project).toLowerCase().includes(query)
        || safe(t.org).toLowerCase().includes(query);
    });

  let done=0, todo=0;
  teams.forEach(t=>{
    const doneForMe = judgeId ? isDoneForJudge(t.id, judgeId) : false;
    done += doneForMe ? 1 : 0;
    todo += doneForMe ? 0 : 1;

    const card = document.createElement("div");
    card.className = "teamCard";
    card.innerHTML = `
      <div class="teamTop">
        <div>
          <div class="teamId">${t.id}</div>
          <div class="small"><b>${t.project || "â€”"}</b></div>
          <div class="small">${t.org || "â€”"}</div>
        </div>
        <div class="state ${doneForMe ? "done":"todo"}">
          ${doneForMe ? "âœ… ØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡" : "â³ ØºÙŠØ± Ù…Ù‚ÙŠÙ‘Ù…"}
        </div>
      </div>
    `;
    card.addEventListener("click", ()=>{
      openTeamForEval(t.id);
      setTab("eval");
    });
    grid.appendChild(card);
  });

  $("countTeams").textContent = state.teams.length;
  $("countDone").textContent = done;
  $("countTodo").textContent = todo;
}

function openTeamForEval(teamId){
  const t = state.teams.find(x => safe(x.id).toLowerCase() === safe(teamId).toLowerCase());
  currentTeamId = t?.id || safe(teamId);
  $("teamId").value = currentTeamId;
  $("projectTitle").value = t?.project || "";
  $("org").value = t?.org || "";
  // Ù…Ø³Ø­ Ø¯Ø±Ø¬Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
  CRITERIA.forEach((_,i)=>{
    const s = document.querySelector(`.score[data-i="${i}"]`);
    const n = document.querySelector(`.note[data-i="${i}"]`);
    if(s) s.value = "0";
    if(n) n.value = "";
  });
  calcTotal(); updatePills();
  msg($("evalMsg"), `ÙØªØ­ Ø§Ù„ÙØ±ÙŠÙ‚ ${currentTeamId} Ù„Ù„ØªÙ‚ÙŠÙŠÙ….`, "");
}

function buildPayload(){
  return {
    teamId: safe($("teamId").value),
    projectTitle: safe($("projectTitle").value),
    org: safe($("org").value),
    judgeId: safe($("judgeId").value),
    total: calcTotal(),
    items: CRITERIA.map((c,i)=>({
      idx:i+1,
      criterion:c,
      score:Number(document.querySelector(`.score[data-i="${i}"]`).value||0),
      note:safe(document.querySelector(`.note[data-i="${i}"]`).value)
    })),
    savedAt: new Date().toISOString()
  };
}

function validate(payload){
  if(!payload.judgeId) return "Ø§ÙƒØªØ¨ Judge ID Ø£ÙˆÙ„Ø§Ù‹ (Ù…Ù‡Ù… Ù„Ù„ØªØªØ¨Ø¹ ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±).";
  if(!payload.teamId) return "Ø­Ø¯Ø¯ ÙØ±ÙŠÙ‚ (QR Ø£Ùˆ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©).";
  const missing = payload.items.find(x=>!x.score);
  if(missing) return "Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ø¯Ø±Ø¬Ø© Ù„ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ (1â€“5).";
  return "";
}

/* Save with dedup per (teamId + judgeId) */
async function saveEvaluation(){
  const el = $("evalMsg");
  msg(el, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...");

  const payload = buildPayload();
  const err = validate(payload);
  if(err){ msg(el, err, "err"); return; }

  try{
    const rec = await getRecord();

    // dedup (team + judge)
    rec.evaluations = rec.evaluations.filter(e =>
      !(safe(e.teamId).toLowerCase()===payload.teamId.toLowerCase()
        && safe(e.judgeId).toLowerCase()===payload.judgeId.toLowerCase())
    );
    rec.evaluations.push(payload);

    // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ teams Ù…Ù† Ø§Ù„Ø§Ø¯Ù…Ù† ÙƒÙ…Ø§ Ù‡ÙŠ
    rec.teams = rec.teams || [];
    await putRecord(rec);

    // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù…
    state = rec;
    msg(el, `ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ… (${payload.total}/65)`, "ok");
    renderTeams();
  }catch(e){
    console.error(e);
    msg(el, "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ£ÙƒØ¯ Ù…Ù† BIN_ID Ùˆ KEY Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„.", "err");
  }
}

/* Next team (Ø­Ø³Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©) */
function nextTeam(){
  const judgeId = safe($("judgeId").value);
  const sorted = state.teams.slice().sort((a,b)=> safe(a.id).localeCompare(safe(b.id),"en",{numeric:true}));
  if(!sorted.length) return;

  const idx = sorted.findIndex(t => safe(t.id).toLowerCase() === safe(currentTeamId).toLowerCase());
  // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ ÙØ±ÙŠÙ‚ ØºÙŠØ± Ù…Ù‚ÙŠÙ‘Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
  for(let k=1; k<=sorted.length; k++){
    const t = sorted[(idx + k + sorted.length) % sorted.length];
    if(!judgeId || !isDoneForJudge(t.id, judgeId)){
      openTeamForEval(t.id);
      return;
    }
  }
  msg($("evalMsg"), "ÙƒÙ„ Ø§Ù„ÙØ±Ù‚ ØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„Ùƒ âœ…", "ok");
}

/* =========================
   Results
   ========================= */
function stats(arr){
  const a = arr.map(Number).filter(n=>Number.isFinite(n));
  const n = a.length;
  if(!n) return {n:0, avg:0};
  const sum = a.reduce((x,y)=>x+y,0);
  return { n, avg: sum/n };
}

function renderResults(){
  const tbody = $("resultsBody");
  tbody.innerHTML = "";

  const grouped = new Map();
  state.evaluations.forEach(e=>{
    const id = safe(e.teamId).toUpperCase();
    if(!id) return;
    if(!grouped.has(id)){
      grouped.set(id, { teamId:id, projectTitle:safe(e.projectTitle), org:safe(e.org), totals:[] });
    }
    const g = grouped.get(id);
    if(!g.projectTitle && e.projectTitle) g.projectTitle = safe(e.projectTitle);
    if(!g.org && e.org) g.org = safe(e.org);
    g.totals.push(Number(e.total||0));
  });

  const arr = [...grouped.values()].map(x=>{
    const s = stats(x.totals);
    return {...x, judges:s.n, avg:s.avg};
  });

  arr.sort((a,b)=> b.avg - a.avg);

  arr.forEach((t,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="rank">${i+1}</span></td>
      <td><b>${t.teamId}</b></td>
      <td>${t.projectTitle || "â€”"}</td>
      <td>${t.org || "â€”"}</td>
      <td>${t.judges}</td>
      <td><b>${t.avg.toFixed(2)}</b></td>
    `;
    tbody.appendChild(tr);
  });

  const top = $("top3");
  top.innerHTML = "";
  arr.slice(0,3).forEach((t,i)=>{
    const div = document.createElement("div");
    div.className = "criteriaItem";
    div.innerHTML = `
      <div class="criteriaTitle">ğŸ† Ø§Ù„Ù…Ø±ÙƒØ² ${i+1} â€” ${t.teamId} (${t.avg.toFixed(2)}/65)</div>
      <div class="small"><b>${t.projectTitle || "â€”"}</b> â€” ${t.org || "â€”"} â€” Ø­ÙƒÙ‘Ø§Ù…: ${t.judges}</div>
    `;
    top.appendChild(div);
  });

  msg($("resMsg"), "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ âœ…", "ok");
}

/* =========================
   Load
   ========================= */
async function loadAll(){
  msg($("dashMsg"), "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");
  try{
    state = await getRecord();
    renderTeams();
    msg($("dashMsg"), "ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ âœ…", "ok");
  }catch(e){
    console.error(e);
    msg($("dashMsg"), "ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† BIN_ID Ùˆ KEY.", "err");
  }
}

/* =========================
   Events & Init
   ========================= */
renderCriteria();

$("tabDash").addEventListener("click", ()=>setTab("dash"));
$("tabEval").addEventListener("click", ()=>setTab("eval"));
$("tabRes").addEventListener("click", ()=>{ setTab("res"); renderResults(); });

$("btnReload").addEventListener("click", loadAll);
$("search").addEventListener("input", renderTeams);
$("judgeId").addEventListener("input", renderTeams);

document.addEventListener("change", (e)=>{
  if(e.target.classList.contains("score")) calcTotal();
});
document.addEventListener("input", (e)=>{
  if(["teamId","projectTitle","org"].includes(e.target.id)) updatePills();
});

$("btnSave").addEventListener("click", saveEvaluation);
$("btnNext").addEventListener("click", nextTeam);

$("btnClear").addEventListener("click", ()=>{
  $("teamId").value=""; $("projectTitle").value=""; $("org").value="";
  CRITERIA.forEach((_,i)=>{
    document.querySelector(`.score[data-i="${i}"]`).value="0";
    document.querySelector(`.note[data-i="${i}"]`).value="";
  });
  calcTotal(); updatePills();
  msg($("evalMsg"), "ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ…", "ok");
});

$("btnCopyCurrentLink").addEventListener("click", async ()=>{
  const tid = safe($("teamId").value || currentTeamId);
  if(!tid){ msg($("dashMsg"), "Ù…Ø§ÙÙŠ ÙØ±ÙŠÙ‚ Ù…Ø­Ø¯Ø¯.", "err"); return; }
  const base = location.href.replace(/index\.html.*/,"index.html");
  const link = base + "?team=" + encodeURIComponent(tid) + "#/eval";
  try{
    await navigator.clipboard.writeText(link);
    msg($("dashMsg"), "ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ±ÙŠÙ‚ âœ… (Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ù„ØªÙˆÙ„ÙŠØ¯ QR)", "ok");
  }catch{
    msg($("dashMsg"), "ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.", "err");
  }
});

$("btnRefreshResults").addEventListener("click", async ()=>{
  msg($("resMsg"), "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...");
  try{
    state = await getRecord();
    renderResults();
  }catch(e){
    console.error(e);
    msg($("resMsg"), "ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«.", "err");
  }
});

// Routing + QR
function route(){
  const h = (location.hash || "#/dash").toLowerCase();
  if(h.includes("eval")) setTab("eval");
  else if(h.includes("res")) setTab("res");
  else setTab("dash");
}
window.addEventListener("hashchange", route);

// Load + open QR team if provided
(async ()=>{
  route();
  await loadAll();

  const teamFromQR = getParam("team");
  if(teamFromQR){
    openTeamForEval(teamFromQR);
    setTab("eval");
  }
})();
</script>
</body>
</html>