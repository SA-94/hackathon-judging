<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø­ÙƒÙ‘Ø§Ù…</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#111c33; --muted:#94a3b8; --text:#e5e7eb;
      --line:rgba(148,163,184,.18); --ok:#22c55e; --danger:#ef4444; --brand:#38bdf8; --shadow:0 16px 50px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1000px 500px at 15% 0%, rgba(56,189,248,.15), transparent 60%),var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:auto;padding:18px}
    .topbar{background:rgba(15,23,42,.75);border:1px solid var(--line);border-radius:var(--r);padding:14px 16px;box-shadow:var(--shadow);display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center}
    h1{margin:0;font-size:16px}
    .sub{margin-top:6px;color:var(--muted);font-size:12px}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:0;border-radius:14px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, rgba(56,189,248,.95), rgba(34,197,94,.92));color:#07121f}
    .btn.ghost{background:rgba(17,28,51,.55);border:1px solid var(--line);color:var(--text)}
    .card{background:rgba(15,23,42,.75);border:1px solid var(--line);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-top:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .teams{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:10px}
    @media (max-width:980px){.teams{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.teams{grid-template-columns:1fr}}
    .teamCard{border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(17,28,51,.45);cursor:pointer;transition:transform .08s ease, opacity .2s ease}
    .teamCard:hover{transform:translateY(-1px)}
    .teamCard.disabled{opacity:.55; cursor:not-allowed}
    .teamCard.disabled:hover{transform:none}
    .teamTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .teamTitle{font-weight:1000}
    .teamMeta{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.5}
    .badge{font-size:12px;font-weight:1000;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
    .badge.done{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
    .empty{color:var(--muted);text-align:center;padding:26px;border:1px dashed var(--line);border-radius:16px;background:rgba(17,28,51,.25);margin-top:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(17,28,51,.55);color:var(--text);outline:none;font-size:14px}
    textarea{min-height:78px;resize:vertical}
    .criteriaItem{border:1px solid var(--line);background:rgba(17,28,51,.45);border-radius:16px;padding:12px;margin:10px 0}
    .critTitle{margin:0;font-size:13px;font-weight:1000;line-height:1.5}
    .critGrid{display:grid;grid-template-columns:170px 1fr;gap:10px;margin-top:10px}
    @media (max-width:720px){.critGrid{grid-template-columns:1fr}}
    .totalBar{display:flex;justify-content:space-between;align-items:center;gap:10px;border-radius:16px;padding:12px 14px;background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.28);margin-top:12px}
    .totalBar .big{font-size:16px;font-weight:1000}
    .msg{margin-top:10px;font-size:13px;color:var(--muted)}
    .msg.ok{color:var(--ok);font-weight:900}
    .msg.err{color:var(--danger);font-weight:900}

    /* modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{max-width:480px;width:100%;background:rgba(15,23,42,.95);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .modal h2{margin:0;font-size:14px}
    .modal .sub{margin-top:8px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø­ÙƒÙ‘Ø§Ù…</h1>
      <div class="sub">Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© â†’ ØªØ¸Ù‡Ø± Ù„Ùƒ ÙƒØ±ÙˆØª Ø§Ù„ÙØ±Ù‚ â†’ Ù‚ÙŠÙ‘Ù… ÙˆØ§Ø­ÙØ¸ â†’ âœ… ØªØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ±Øª</div>
    </div>
    <div class="btnRow">
      <button class="btn ghost" id="btnRefresh">ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn ghost" id="btnChangeName">ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø­ÙƒÙ…</button>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„ÙƒØ±ÙˆØª -->
  <section id="pageCards" class="card" style="display:none">
    <div class="grid">
      <div>
        <h1 style="font-size:14px;margin:0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±Ù‚</h1>
        <div class="sub">Ø§Ù„Ø­ÙƒÙ…: <b id="judgeNameLabel">â€”</b></div>
      </div>
      <div>
        <label>Ø¨Ø­Ø«</label>
        <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ù€ TeamID Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" />
      </div>
    </div>

    <div id="teamsGrid" class="teams"></div>
    <div id="emptyState" class="empty" style="display:none">
      Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ù‚ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù† ğŸ‘€<br><br>
      <button class="btn primary" id="btnRefresh2">ØªØ­Ø¯ÙŠØ«</button>
    </div>

    <div class="msg" id="cardsMsg"></div>
  </section>

  <!-- ØµÙØ­Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
  <section id="pageEval" class="card" style="display:none">
    <div class="grid">
      <div>
        <h1 style="font-size:14px;margin:0">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h1>
        <div class="sub">
          <b id="evalTeamHeader">â€”</b>
        </div>
      </div>
      <div class="btnRow" style="justify-content:flex-end">
        <button class="btn ghost" id="btnBack">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙƒØ±ÙˆØª</button>
      </div>
    </div>

    <div id="criteriaContainer"></div>

    <div class="totalBar">
      <div>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</div>
      <div class="big"><span id="total">0</span> / 65</div>
    </div>

    <div class="btnRow" style="margin-top:12px">
      <button class="btn primary" id="btnSave">ØªØ£ÙƒÙŠØ¯ / Ø­ÙØ¸</button>
    </div>

    <div class="msg" id="evalMsg"></div>
  </section>
</div>

<!-- Modal Ø§Ø³Ù… Ø§Ù„Ø­ÙƒÙ… -->
<div class="overlay" id="overlay">
  <div class="modal">
    <h2>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­ÙƒÙ…</h2>
    <div class="sub">Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·ØŒ Ø¹Ø´Ø§Ù† Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠÙ…ÙŠÙ‘Ø² ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙƒ ÙˆÙŠØ¸Ù‡Ø± âœ… Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ±ÙˆØª.</div>
    <label>Ø§Ø³Ù… Ø§Ù„Ø­ÙƒÙ…</label>
    <input id="judgeNameInput" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ / J01" />
    <div class="btnRow" style="margin-top:12px">
      <button class="btn primary" id="btnConfirmName">ØªØ£ÙƒÙŠØ¯</button>
    </div>
    <div class="msg" id="nameMsg"></div>
  </div>
</div>

<script>
/* =========================
   CONFIG (JSONBin)
   ========================= */
const JSONBIN_BIN_ID  = "699c7c98d0ea881f40d25331";
const JSONBIN_API_KEY = "$2a$10$8rkoiVkou/iglqXxQNfmduvpxAqN6XY6fILRTcIcc0Hw1MyF2g8sa";

/* =========================
   CRITERIA (13 Ø¨Ù†Ø¯)
   ========================= */
const CRITERIA = [
  "ÙˆØ¶ÙˆØ­ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© ÙˆÙ…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„ÙÙƒØ±Ø© Ù„Ù‡Ø§",
  "Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø±ØªØ¨Ø§Ø·Ù‡ Ø¨Ø§Ù„ÙÙƒØ±Ø© ÙˆØ¹Ù…Ù‚ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©",
  "ÙˆØ¬ÙˆØ¯/ÙˆØ¶ÙˆØ­ Ø§Ù„Ø­Ù„ Ø§Ù„ØªÙ‚Ù†ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ³ØªÙ†Ø¯ Ø¥Ù„ÙŠÙ‡ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±",
  "Ø¥Ø¨Ø¯Ø§Ø¹ ÙˆØªÙ…ÙŠÙ‘Ø² Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±",
  "Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ù„Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©",
  "ØªÙ…ÙŠÙ‘Ø² Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø± Ø¹Ù† Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙØ±Ø© + Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ÙŠ",
  "ÙˆØ¶ÙˆØ­ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© + Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±",
  "ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¹ÙˆØ§Ø¦Ù‚ ÙˆØ®Ø·Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°",
  "Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„ØªÙ†ÙÙŠØ° ÙˆÙˆØ§Ù‚Ø¹ÙŠØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª (Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ‰)",
  "Ø¬Ø¯ÙˆÙ‰ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø± ØµØ­ÙŠÙ‹Ø§ ÙˆØ§Ù‚ØªØµØ§Ø¯ÙŠÙ‹Ø§ ÙˆØ§Ø¬ØªÙ…Ø§Ø¹ÙŠÙ‹Ø§",
  "Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ (Ø¥Ù„Ù‚Ø§Ø¡/Ù„ØºØ© Ø¬Ø³Ø¯/Ø§Ù„ØªØ²Ø§Ù… ÙˆÙ‚Øª)",
  "ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§ÙƒØªÙ…Ø§Ù„ Ø¹Ù†Ø§ØµØ±Ù‡",
  "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù„Ø¬Ù†Ø© Ø¨Ø¯Ù‚Ø© ÙˆÙ…Ù‡Ù†ÙŠØ©"
];

/* =========================
   Helpers
   ========================= */
const $ = (id)=>document.getElementById(id);
const qsa = (sel)=>[...document.querySelectorAll(sel)];
const safe = (x)=>String(x??"").trim();

function show(el, on){ el.style.display = on ? "block" : "none"; }
function msg(el, text, kind=""){ el.className="msg"+(kind?(" "+kind):""); el.textContent=text; }

async function getRecord(){
  const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
    headers: { "X-Master-Key": JSONBIN_API_KEY }
  });
  if(!res.ok) throw new Error("Fetch failed");
  const data = await res.json();
  const r = data?.record || { teams:[], evaluations:[] };
  r.teams = Array.isArray(r.teams) ? r.teams : [];
  r.evaluations = Array.isArray(r.evaluations) ? r.evaluations : [];
  return r;
}
async function putRecord(record){
  const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
    method:"PUT",
    headers:{ "Content-Type":"application/json", "X-Master-Key": JSONBIN_API_KEY },
    body: JSON.stringify(record)
  });
  if(!res.ok) throw new Error("Update failed");
}

function calcTotal(){
  const sum = qsa(".score").reduce((a,s)=>a+Number(s.value||0),0);
  $("total").textContent = sum;
  return sum;
}

/* =========================
   State
   ========================= */
let state = { teams:[], evaluations:[] };
let judgeName = "";
let currentTeam = null; // {id, teamName, projectName}

function evalKey(teamId, judge){
  return safe(teamId).toLowerCase()+"__"+safe(judge).toLowerCase();
}
function findEval(teamId){
  const key = evalKey(teamId, judgeName);
  return state.evaluations.find(e => evalKey(e.teamId, e.judgeName) === key) || null;
}
function isDone(teamId){
  return !!findEval(teamId);
}

/* =========================
   UI: render criteria
   ========================= */
function renderCriteria(){
  const box = $("criteriaContainer");
  box.innerHTML = "";
  CRITERIA.forEach((text,i)=>{
    const div = document.createElement("div");
    div.className = "criteriaItem";
    div.innerHTML = `
      <p class="critTitle">${i+1}) ${text}</p>
      <div class="critGrid">
        <div>
          <label>Ø§Ù„Ø¯Ø±Ø¬Ø©</label>
          <select class="score" data-i="${i}">
            <option value="0">Ø§Ø®ØªØ±</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option>
          </select>
        </div>
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <textarea class="note" data-i="${i}" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></textarea>
        </div>
      </div>
    `;
    box.appendChild(div);
  });
  calcTotal();
}

document.addEventListener("change",(e)=>{
  if(e.target.classList.contains("score")) calcTotal();
});

/* =========================
   UI: render cards
   ========================= */
function renderCards(){
  $("judgeNameLabel").textContent = judgeName || "â€”";
  const grid = $("teamsGrid");
  grid.innerHTML = "";

  const query = safe($("search").value).toLowerCase();
  const teams = state.teams
    .slice()
    .sort((a,b)=> safe(a.id).localeCompare(safe(b.id),"en",{numeric:true}))
    .filter(t=>{
      if(!query) return true;
      return safe(t.id).toLowerCase().includes(query)
        || safe(t.teamName).toLowerCase().includes(query)
        || safe(t.projectName).toLowerCase().includes(query);
    });

  if(!teams.length){
    show($("emptyState"), true);
    show(grid, false);
    return;
  }

  show($("emptyState"), false);
  show(grid, true);

  teams.forEach(t=>{
    const done = isDone(t.id);
    const card = document.createElement("div");
    card.className = "teamCard" + (done ? " disabled" : "");
    card.innerHTML = `
      <div class="teamTop">
        <div class="teamTitle">${t.teamName || "â€”"} â€” <span style="color:var(--muted);font-weight:900">${t.id}</span></div>
        <div class="badge ${done ? "done":""}">${done ? "âœ… ØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡" : "â³"}</div>
      </div>
      <div class="teamMeta"><b>Ø§Ù„Ù…Ø´Ø±ÙˆØ¹:</b> ${t.projectName || "â€”"}</div>
    `;

    card.addEventListener("click", ()=>{
      if(done){
        msg($("cardsMsg"), "Ù„Ù‚Ø¯ ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„ÙØ±ÙŠÙ‚ Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…", "ok");
        return;
      }
      openEval(t.id);
    });

    grid.appendChild(card);
  });
}

/* =========================
   Navigation
   ========================= */
function openCards(){
  show($("pageCards"), true);
  show($("pageEval"), false);
  renderCards();
}

function openEval(teamId){
  const t = state.teams.find(x=>safe(x.id).toLowerCase()===safe(teamId).toLowerCase());
  if(!t){
    msg($("cardsMsg"), "Ù‡Ø°Ø§ Ø§Ù„ÙØ±ÙŠÙ‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.", "err");
    return;
  }

  // âœ… Ù…Ù†Ø¹ ÙØªØ­ ÙØ±ÙŠÙ‚ ØªÙ… ØªÙ‚ÙŠÙŠÙ…Ù‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ø­ØªÙ‰ Ù„Ùˆ Ø­Ø§ÙˆÙ„ Ù…Ù† Ø±Ø§Ø¨Ø·
  if(isDone(t.id)){
    msg($("cardsMsg"), "Ù„Ù‚Ø¯ ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„ÙØ±ÙŠÙ‚ Ù…Ø³Ø¨Ù‚Ù‹Ø§ âœ…", "ok");
    openCards();
    return;
  }

  currentTeam = t;

  $("evalTeamHeader").textContent = `${t.teamName} â€” ${t.id} | Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${t.projectName}`;
  show($("pageCards"), false);
  show($("pageEval"), true);

  // reset
  CRITERIA.forEach((_,i)=>{
    document.querySelector(`.score[data-i="${i}"]`).value = "0";
    document.querySelector(`.note[data-i="${i}"]`).value = "";
  });

  msg($("evalMsg"), "", "");
  calcTotal();
}

/* =========================
   Save evaluation
   ========================= */
function buildPayload(){
  return {
    teamId: safe(currentTeam?.id),
    teamName: safe(currentTeam?.teamName),
    projectName: safe(currentTeam?.projectName),
    judgeName: safe(judgeName),
    total: calcTotal(),
    items: CRITERIA.map((c,i)=>({
      idx:i+1,
      criterion:c,
      score:Number(document.querySelector(`.score[data-i="${i}"]`).value||0),
      note:safe(document.querySelector(`.note[data-i="${i}"]`).value)
    })),
    savedAt: new Date().toISOString()
  };
}

function validate(payload){
  if(!payload.judgeName) return "Ø§Ø³Ù… Ø§Ù„Ø­ÙƒÙ… Ù…Ø·Ù„ÙˆØ¨.";
  if(!payload.teamId) return "Ø­Ø¯Ø¯ ÙØ±ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹.";
  const missing = payload.items.find(x=>!x.score);
  if(missing) return "Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø± Ø¯Ø±Ø¬Ø© Ù„ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯ (1â€“5).";
  return "";
}

async function save(){
  const el = $("evalMsg");
  msg(el, "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...");

  const payload = buildPayload();
  const err = validate(payload);
  if(err){ msg(el, err, "err"); return; }

  try{
    const rec = await getRecord();

    // (Ø¢Ù…Ù†) Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ù„Ù†ÙØ³ Ø§Ù„Ø­ÙƒÙ…/Ø§Ù„ÙØ±ÙŠÙ‚
    rec.evaluations = rec.evaluations.filter(e =>
      !(safe(e.teamId).toLowerCase()===payload.teamId.toLowerCase()
        && safe(e.judgeName).toLowerCase()===payload.judgeName.toLowerCase())
    );

    rec.evaluations.push(payload);
    await putRecord(rec);

    state = rec;
    msg(el, `ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ… (${payload.total}/65)`, "ok");

    // Ø±Ø¬Ù‘Ø¹ Ù„Ù„ÙƒØ±ÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    setTimeout(() => {
      openCards();
      msg($("cardsMsg"), "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… âœ…", "ok");
    }, 450);

  }catch(e){
    console.error(e);
    msg(el, "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ØªØ£ÙƒØ¯ Ù…Ù† BIN_ID Ùˆ KEY Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„.", "err");
  }
}

/* =========================
   Judge name flow
   ========================= */
function openNameModal(){
  show($("overlay"), true);
  $("judgeNameInput").value = judgeName || "";
  msg($("nameMsg"), "");
  setTimeout(()=> $("judgeNameInput").focus(), 50);
}
function closeNameModal(){ show($("overlay"), false); }
function setJudgeName(name){
  judgeName = safe(name);
  localStorage.setItem("judgeName", judgeName);
  $("judgeNameLabel").textContent = judgeName;
}

/* =========================
   Load
   ========================= */
async function refresh(){
  msg($("cardsMsg"), "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...");
  try{
    state = await getRecord();
    msg($("cardsMsg"), "ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ…", "ok");
    renderCards();
  }catch(e){
    console.error(e);
    msg($("cardsMsg"), "ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù† BIN_ID Ùˆ KEY.", "err");
  }
}

/* =========================
   Init
   ========================= */
renderCriteria();

$("btnBack").addEventListener("click", openCards);
$("btnSave").addEventListener("click", save);

$("btnRefresh").addEventListener("click", refresh);
$("btnRefresh2").addEventListener("click", refresh);
$("search").addEventListener("input", renderCards);

$("btnChangeName").addEventListener("click", openNameModal);
$("btnConfirmName").addEventListener("click", ()=>{
  const name = safe($("judgeNameInput").value);
  if(!name){ msg($("nameMsg"), "Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹.", "err"); return; }
  setJudgeName(name);
  closeNameModal();
  openCards();
});

(async ()=>{
  judgeName = safe(localStorage.getItem("judgeName"));
  await refresh();

  if(!judgeName){
    openNameModal();
    show($("pageCards"), false);
  }else{
    show($("pageCards"), true);
    openCards();
  }
})();
</script>
</body>
</html>
